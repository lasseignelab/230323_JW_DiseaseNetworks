---
title: "01_gene_targeting"
output: html_document
date: '2023-02-13'
---

This analysis determines gene targeting scores within tissue types for each tissue-specific PANDA regulatory networks. All networks below were filtered to only include positive weights.

#load in required libraries & functions
```{r loading-libraries-functions, results='hide'}
set.seed(2178)
library(netZooR)
library(data.table)
library(dplyr)
library(patchwork)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(magrittr)
library(circlize)
library(readr)
library(gprofiler2)
library(ggridges)
library(here)
source(here("src/functions.R"))
library(styler)
library(lintr)
ptm <- proc.time()
```

## load gene set 
```{r loading-geneset}
# load in gene set for SETBP1 (converted by LW)
setbp1_genes <- read.csv(here("data/SETBP1_Targets/setbp1_targets_geneconversions.csv"))
setbp1_genes <- setbp1_genes$name %>% as.vector()
```

## affected tissues list
```{r}
affected <- c("BRAIN", "HEART", "KIDNEY", "BLADDER", "LUNG", "MUSCLE", "SMALL_INTESTINE", "STOMACH", "ESOPHAGUS")
```


## setting heatmap data needed for the rest of the script
```{r heatmap-color-annotation}
# setting annotation colors
annotation_colors <- list("tissue" = c("ADIPOSE_TISSUE" = "#000000",
"ADRENAL_GLAND" = "#FFFFFF",
"BLADDER" = "#FF0000",
"BLOOD" = "#00FF00",
"BLOOD_VESSEL" = "#0000FF",
"BONE_MARROW" = "#FFFF00",
"BRAIN" = "#FF00FF",
"BREAST" = "#00FFFF",
"CERVIX_UTERI" = "#800000",
"COLON" = "#008000",
"ESOPHAGUS" = "#000080",
"FALLOPIAN_TUBE" = "#808000",
"HEART" = "#800080",
"KIDNEY" = "#008080",
"LIVER" = "#808080",
"LUNG" = "#C0C0C0",
"MUSCLE" = "#FFA500",
"NERVE" = "#A52A2A",
"OVARY" = "#800080",
"PANCREAS" = "#FFC0CB",
"PITUITARY" = "#FFD700",
"PROSTATE" = "#FF8C00",
"SALIVARY_GLAND" = "#ADFF2F",
"SKIN" = "#F0E68C",
"SMALL_INTESTINE" = "#00FA9A",
"SPLEEN" = "#F08080",
"STOMACH" = "#4682B4",
"TESTIS" = "#B0C4DE",
"THYROID" = "#00CED1",
"UTERUS" = "#FF1493",
"VAGINA" = "#DAA520"
))
```

## load in PANDA object containing list of all cell types from Setbp1 data
Here each item returned by the for loop represents a PANDA object for a given cell type that contains the regNet, coopNet, and coregNet for that cell type.
```{r loading-object, results='hide'}
files <- list.files(here("results/PANDA"),
  full.names = TRUE
) # grabbing file names

files # 31 tissues total

regNet_list <- list()

for (i in files) {
  load(i)
  regNet <- pandaResults
  regNet <- regNet@regNet
  name <- sub(here("results/PANDA/gtex_"), "", i)
  name <- sub("_PANDA.Rdata*", "", name)
  #assign(paste0(name, ".regNet"), regNet)
  regNet_list[[name]] <- regNet
  rm(pandaResults)
  rm(regNet)
}
```

```{r save-object}
#save(regNet_list, file = here("results/gene_targeting/regNet_list.Rdata")) #commented out after first save to avoid overwriting
```

## Visualizing edge weight distributions filtered and unfiltered
```{r visualize-distribution-of-unfiltered-regNet-scores}
# Create an empty list to store the melted data frames
merged_regNet_list <- list()

# Loop through the list and melt the data frames
for (i in seq_along(regNet_list)) {
  melted <- as.data.frame(reshape2::melt(regNet_list[[i]]),
                          varnames = c("TF", "gene"),
                          value.name = "edge_weight") # melting dataframe
  
  melted <- as.data.frame(melted[, 3])
  colnames(melted) <- "edge_weight"
  
  # Extract the name of the list item and create the 'tissue' column
  melted$tissue <- names(regNet_list)[i]
  
  # Store the melted data frame in the merged_regNet_list
  merged_regNet_list[[i]] <- melted
  
  print(paste0(names(regNet_list)[i], " melted and stored"))
}

# naming list  items
names(merged_regNet_list) <- names(regNet_list)

merged <- bind_rows(merged_regNet_list)
```


```{r plotting-edgeweights}
# plotting distribution
png(
  filename = here("results/gene_targeting/regNet_edgeweight_dist.png"),
  width = 1000,
  height = 500
)
ggplot(data = merged, aes(
  x = edge_weight,
  group = tissue, color = tissue
)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Distribution of regNet edge weights in GTEx Data") +
  theme_bw() # +
  #scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

Note: all negative edge weights were changed to 0
```{r visualize-distribution-of-filtered-het-regNet-scores}
# grabbing only positive edge weights
merged_pos <- merged[merged$edge_weight > 0, ]

# plotting only positive het edge weights
png(
  filename = here("results/gene_targeting/regNet_edgeweight_pos_dist.png"),
  width = 1000,
  height = 500
)
ggplot(data = merged_pos, aes(x = edge_weight, group = tissue, color = tissue)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Distribution of regNet edge weights > 0 in GTEx Tissues") +
  theme_bw() #+
  #scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

## Filtering for only positive edge weights, and calculating targeting scores:
Gene targeting score, a numerical score representing the extent to which a gene is targeted by TFs in a given biological context. The gene targeting score is calculated by summing the weights of all inbound regulatory edges for a gene (https://doi.org/10.3389/fgene.2021.649942). 
* regNetmatrix: The PANDA regNet output matrix of TF and Genes and their edge weights from running pandaR on GTEx expression, TF-Motif, and PPI inputs.

```{r calc-targeting}
# filtering for only positive edge weights
gtex_targeting <- targetingCalc_gtex(regNetmatrix_list = regNet_list)
```

```{r save-targeting}
save(gtex_targeting, file = here("results/gene_targeting/gtex_targeting_.Rdata"))
```


```{r constructing-gene-targeting-matrix}
# grabbing targeting scores for genes
targeting <- gtex_targeting %>%
  purrr::reduce(full_join, by = "gene") %>%
  select(., contains(c("gene", "targeting_score"))) # did not grab edge_weight_pos column here

# grabbing colnames and setting for new dataframe generated above
names <- names(gtex_targeting) %>%
  append("gene", .)
colnames(targeting) <- names
```

```{r saving-outputs}
save(targeting, file = here("data/gtex_targeting.Rdata"))

write.csv(targeting, file = here("results/gene_targeting/gtex_targeting_scores.csv"))
```

```{r ridgeline-plot-targeting-scores}
melted <- melt(targeting) #melting data

colnames(melted) <- c("gene", "tissue", "targeting_score")

png(here("results/gene_targeting/targeting_score_ridgeline.png"), height = 500, width = 800)
ggplot(melted) +
  geom_density_ridges(aes(x = targeting_score, y = tissue, fill = tissue), alpha = 0.8) +
  theme_bw() +
  ggtitle("Gene Targeting Score Distribution in GTEx Tissues")
dev.off()
```


# Investigate targeting rank within each tissue

```{r find-top-targeted-genes-within-tissue}
tissues <- colnames(targeting) %>% .[which(. != "gene")]
tissues

# rank genes by targeting for each tissue , find top 20
gene_rank <- list() # creating empty list to store within

for (i in tissues) {
  rank <- targeting[, names(targeting) %in% c("gene", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(tissue = i) %>%
    slice(1:20) %>%
    rename(targeting_score = i)
  gene_rank[[i]] <- rank
}

gene_rank_top <- do.call(bind_rows, gene_rank) # collapsing list into single df using row binding


gene_rank <- list() # creating empty list to store within

for (i in tissues) {
  rank <- targeting[, names(targeting) %in% c("gene", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(tissue = i) %>%
    rename(targeting_score = i)
  gene_rank[[i]] <- rank
}

gene_rank_all <- do.call(bind_rows, gene_rank)
```


```{r visualizing-gene-rank-with-heatmap}
## formatting input data
data <- gene_rank_top[, c("gene", "targeting_score", "tissue"), drop = FALSE]
data <- pivot_wider(data, names_from = c("tissue"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "tissue"
# setting plot path
plot_path <- here("results/gene_targeting/gene_targeting_top20_within_tissue_heatmap.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of Top 20 genes within GTEx Tissues"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 3000, height = 3500)
```

```{r visualizing-ALL-het-gene-rank-heatmap}
## formatting input data
data <- gene_rank_all[, c("gene", "targeting_score", "tissue"), drop = FALSE]
data <- pivot_wider(data, names_from = c("tissue"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names
# setting meta colname
meta_colname <- "tissue"
# setting plot path
plot_path <- here("results/gene_targeting/gene_targeting_all_within_tissue.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of all genes within GTEx Tissues"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, width = 3000, height = 3500)
```

```{r het-setbp1-gene-targets-within}
data <- gene_rank_all[gene_rank_all$gene %in% setbp1_genes, ]

## formatting input data
data <- data[, c("gene", "targeting_score", "tissue"), drop = FALSE]
data <- pivot_wider(data, names_from = c("tissue"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$gene # add gene names as rownames
data <- data[, -1, drop = FALSE] # drop gene column
rownames(data) <- names

# setting meta colname
meta_colname <- "tissue"
# setting plot path
plot_path <- here("results/gene_targeting/gene_targeting_geneset_within_tissue.png")
# setting rowtitle
rowtitle <- "genes"
# setting columntitle
plot_title <- "Targeting of Setbp1 and known target genes within GTEx tissues"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 3000, height = 8500)
```

# investigating tf tareting of Setbp1
```{r calc-targeting}
# filtering for only positive edge weights
gtex_tf_targeting <- tf_targetingCalc_gtex(regNetmatrix_list = regNet_list)
```

```{r constructing-gene-targeting-matrix}
# grabbing targeting scores for genes
tf_targeting <- gtex_tf_targeting %>%
  purrr::reduce(full_join, by = "tf") %>%
  select(., contains(c("tf", "targeting_score"))) # did not grab edge_weight_pos column here

# grabbing colnames and setting for new dataframe generated above
names <- names(gtex_tf_targeting) %>%
  append("tf", .)
colnames(tf_targeting) <- names
```
# Investigate targeting rank within each tissue

```{r find-top-targeted-genes-within-tissue}
tissues <- colnames(tf_targeting) %>% .[which(. != "tf")]
tissues
```

```{r}
tf_rank <- list() # creating empty list to store within

for (i in tissues) {
  rank <- tf_targeting[, names(tf_targeting) %in% c("tf", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(tissue = i) %>%
    rename(targeting_score = i)
  tf_rank[[i]] <- rank
}

tf_rank_all <- do.call(bind_rows, tf_rank)
```
```{r het-setbp1-tf-targets-within}
data <- tf_rank_all[tf_rank_all$tf %in% setbp1_genes, ]

## formatting input data
data <- data[, c("tf", "targeting_score", "tissue"), drop = FALSE]
data <- pivot_wider(data, names_from = c("tissue"), values_from = "targeting_score", names_repair = "minimal")
data[is.na(data)] <- 0
names <- data$tf # add tf names as rownames
data <- data[, -1, drop = FALSE] # drop tf column
rownames(data) <- names

# setting meta colname
meta_colname <- "tissue"
# setting plot path
plot_path <- here("results/gene_targeting/tf_targeting_geneset_within_tissue.png")
# setting rowtitle
rowtitle <- "TFs"
# setting columntitle
plot_title <- "Targeting of Setbp1 and known target TFs within GTEx tissues"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 3000, height = 5000)
```

```{r visualizing-affected-tissues}
data <- tf_rank_all[tf_rank_all$tf == "SETBP1", ]

data$tissue_status <- ifelse(data$tissue %in% affected, "affected", "not_affected")

# Plot the lollipop plot with the color condition
png(
  filename = here("results/gene_targeting/SETBP1_tf_targeting_lolli.png"),
  width = 2000,
  height = 1500,
  res = 300
)
tf_lolli <- ggplot(data, aes(x = tissue, y = targeting_score)) +
  geom_segment(aes(x = tissue, xend = tissue, y = 0, yend = targeting_score)) +
  geom_point(size = 5, aes(fill = tissue_status), color = "black", alpha = 1, shape = 21) +
  scale_fill_manual(values = c("affected" = "#2C1D6C", "not_affected" = alpha("#D3B1C5", 0.3))) +
  theme_bw() +
  coord_flip() +
  ggtitle("TF Targeting Scores of SETBP1 in GTEx Tissues") +
  labs(x = "GTEx Tissue", y = "Targeting Score", fill = "Tissue Status") +
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(color = "black")) + 
  theme(axis.text.y = element_text(color = "black")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.title.y = element_text(face = "bold")) +
  theme(axis.title.x = element_text(face = "bold")) +
  theme(title = element_text(face = "bold")) +
  theme(plot.title = element_text(hjust = 0))
tf_lolli
dev.off()

##maybe incorporate circle size as tissue specific edge with setbp1 tTF?

data <- gene_rank_all[gene_rank_all$gene == "SETBP1", ]

data$tissue_status <- ifelse(data$tissue %in% affected, "affected", "not_affected")

# Plot the lollipop plot with the color condition
png(
  filename = here("results/gene_targeting/SETBP1_gene_targeting_lolli.png"),
  width = 2000,
  height = 1500,
  res = 300
)
gene_lolli <- ggplot(data, aes(x = tissue, y = targeting_score)) +
  geom_segment(aes(x = tissue, xend = tissue, y = 0, yend = targeting_score)) +
  geom_point(size = 5, aes(fill = tissue_status), color = "black", alpha = 1, shape = 21) +
  scale_fill_manual(values = c("affected" = "#2C1D6C", "not_affected" = alpha("#D3B1C5", 0.3))) +
  theme_bw() +
  coord_flip() +
  ggtitle("Gene Targeting Scores of SETBP1 in GTEx Tissues") +
  labs(x = "GTEx Tissue", y = "Targeting Score", fill = "Tissue Status") +
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(color = "black")) + 
  theme(axis.text.y = element_text(color = "black")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.title.y = element_text(face = "bold")) +
  theme(axis.title.x = element_text(face = "bold")) +
  theme(title = element_text(face = "bold")) +
  theme(plot.title = element_text(hjust = 0))
gene_lolli
dev.off()
```

```{r}
targeting_panel <- tf_lolli + gene_lolli
png(
  filename = here("results/gene_targeting/SETBP1_targeting_combined_lolli.png"),
  width = 3600,
  height = 1500,
  res = 300
)
targeting_panel
dev.off()
```


# calculating differential targeting score between conditions 
GOAL: ID genes with largest difference in targeting _between conditions within each cell type_:
* Using the combined het/ctrl dataframe for each cell type above, calculate the difference (het-ctrl) for the targeting weight where the more positive difference indicates higher gene targeting in het and more negative diff indicates higher gene targeting in ctrl. 
* The closer a value is to 0, the less difference in targeting between conditions for that cell type

# ```{r rearrange-data-calc-diff}
# # ordering data the same
# gene_targeting_all_het <- gene_targeting_all_het[order(gene_targeting_all_het["gene"]), ]
# gene_targeting_all_ctrl <- gene_targeting_all_ctrl[order(gene_targeting_all_ctrl["gene"]), ]
# 
# # Add suffix to column names except the gene column
# new_colnames <- ifelse(names(gene_targeting_all_het) != "gene", paste0(names(gene_targeting_all_het), "_het"), names(gene_targeting_all_het))
# names(gene_targeting_all_het) <- new_colnames
# print(gene_targeting_all_het) # Print the updated dataframe
# 
# new_colnames <- ifelse(names(gene_targeting_all_ctrl) != "gene", paste0(names(gene_targeting_all_ctrl), "_ctrl"), names(gene_targeting_all_ctrl))
# names(gene_targeting_all_ctrl) <- new_colnames
# print(gene_targeting_all_ctrl) # Print the updated dataframe
# 
# # binding data together
# combined_gene_targeting <- merge(gene_targeting_all_het, gene_targeting_all_ctrl, by = "gene")
# ```

# ```{r calculate-het-enriched-diff-targeting}
# # creating empty data frame
# diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
# colnames(diff_gene_targeting) <- "gene" # this will need to be gene or TF respectively
# diff_gene_targeting$gene <- combined_gene_targeting$gene # adding gene
# 
# # calc diff targeting
# cell_names <- colnames(gene_targeting_all_ctrl[, -1]) %>% sub("_ctrl.*", "", .) # all cell type prefixes except gene name, which should be first column in data
# for (i in cell_names) {
#   selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
#   # Check there are two columns with the specified prefix
#   if (length(selected_columns) == 2) {
#     diff_col <- combined_gene_targeting[[selected_columns[1]]] - combined_gene_targeting[[selected_columns[2]]] # ensure difference is `het - control` here
#     # Create a new column name
#     diff_colname <- paste0(i)
#     # Add the result to the result dataframe
#     diff_gene_targeting[[diff_colname]] <- diff_col
#   }
# }
# het_enriched <- diff_gene_targeting
# ```

# ```{r ID-top-quantile-threshold}
# # Create a list to store the histograms
# histograms <- list()
# 
# # Create histograms for each column
# for (col in colnames(het_enriched[,-1])) {
#   p <- ggplot(het_enriched, aes(x = .data[[col]])) +
#     geom_histogram(binwidth = 0.5, fill = "blue", color = "black") +
#     labs(title = col, x = col, y = "Frequency")
#   plot(p)
#   histograms[[col]] <- p
# }
# 
# # calculate quartile for each cell type
# quartiles <- apply(het_enriched[,-1], 2, quantile, probs = c(0.25, 0.5, 0.75))
# 
# # Print the quartiles
# print(quartiles)
# ```
Note: all histograms of differential targeting scores that are het enriched are normally distributed. 

Quartiles of differential targeting scores for each cell type:       
         Bcell CDIC_typeA CDIC_typeB       CDPC       DCT       DLH      LOH     PCTS1      PCTS2       PST        PT endothelial fibroblasts
25% -101.62126  -59.78703  -231.4564 -86.694704  92.38063  89.56326 212.6720 -83.69039   1.566147 -91.64527  45.34969    12.25046  -129.08209
50%  -17.76872  -11.35910  -154.0229  -8.261845 171.09272 157.20370 271.0089 -15.33135  25.472118 -24.44960 102.20607    90.82121   -50.69332
75%   16.94885   47.45649   -46.6720  60.219076 251.63137 254.90153 361.2707  46.17184 151.313144  32.43497 229.60423   174.46237    33.22284
    macrophages  pericytes   podocytes        smcs
25%   -286.7542 -242.11353 -139.109281 -140.379322
50%   -174.6189 -158.62863  -80.767655  -86.957509
75%   -105.0566  -37.85299   -2.302682   -8.890787


Based off the above, all of the het enriched targeting scores will be filtered for each cell type (column) to only include all values <= Q1 (25%) and >= Q3 (75%)

# ```{r filtering-data-based-of-quartiles}
# Bcell <- het_enriched[,c(1,2)]
# Bcell <- subset(Bcell, Bcell <= -101.621 | Bcell >= 16.949)
# colnames(Bcell) <- c("gene", "targeting_score")
# Bcell$cell_type <- "Bcell"
# 
# CDIC_typeA<- het_enriched[, c(1,3)]
# CDIC_typeA<- subset(CDIC_typeA, CDIC_typeA <= -59.787 | CDIC_typeA >= 47.456)
# colnames(CDIC_typeA) <- c("gene", "targeting_score")
# CDIC_typeA$cell_type <- "CDIC_typeA"
# 
# CDIC_typeB<- het_enriched[, c(1,4)]
# CDIC_typeB<- subset(CDIC_typeB, CDIC_typeB <= -231.456 | CDIC_typeB >= -46.672)
# colnames(CDIC_typeB) <- c("gene", "targeting_score")
# CDIC_typeB$cell_type <- "CDIC_typeB"
# 
# 
# CDPC<- het_enriched[, c(1,5)]
# CDPC<- subset(CDPC, CDPC <= -86.695 | CDPC >= 60.219)
# colnames(CDPC) <- c("gene", "targeting_score")
# CDPC$cell_type <- "CDPC"
# 
# DCT<- het_enriched[, c(1,6)]
# DCT<- subset(DCT, DCT <= 92.381 | DCT >= 251.631)
# colnames(DCT) <- c("gene", "targeting_score")
# DCT$cell_type <- "DCT"
# 
# DLH<- het_enriched[, c(1,7)]
# DLH<- subset(DLH, DLH <= 89.563 | DLH >= 254.901)
# colnames(DLH) <- c("gene", "targeting_score")
# DLH$cell_type <- "DLH"
# 
# LOH<- het_enriched[, c(1,8)]
# LOH<- subset(LOH, LOH <= 212.672| LOH >= 361.271)
# colnames(LOH) <- c("gene", "targeting_score")
# LOH$cell_type <- "LOH"
# 
# PCTS1<- het_enriched[, c(1,9)]
# PCTS1<- subset(PCTS1, PCTS1 <= -83.69 | PCTS1 >= 46.172)
# colnames(PCTS1) <- c("gene", "targeting_score")
# PCTS1$cell_type <- "PCTS1"
# 
# PCTS2<- het_enriched[, c(1,10)]
# PCTS2<- subset(PCTS2, PCTS2 <= 1.566 | PCTS2 >= 151.313)
# colnames(PCTS2) <- c("gene", "targeting_score")
# PCTS2$cell_type <- "PCTS2"
# 
# PST<- het_enriched[, c(1,11)]
# PST<- subset(PST, PST <= -91.645 | PST >= 32.435)
# colnames(PST) <- c("gene", "targeting_score")
# PST$cell_type <- "PST"
# 
# PT<- het_enriched[, c(1,12)]
# PT<- subset(PT, PT <= 45.350 | PT >= 229.604)
# colnames(PT) <- c("gene", "targeting_score")
# PT$cell_type <- "PT"
# 
# endothelial<- het_enriched[, c(1,13)]
# endothelial<- subset(endothelial, endothelial <= 12.250 | endothelial >= 174.462)
# colnames(endothelial) <- c("gene", "targeting_score")
# endothelial$cell_type <- "endothelial"
# 
# fibroblasts<- het_enriched[, c(1,14)]
# fibroblasts<- subset(fibroblasts, fibroblasts <= -129.08 | fibroblasts >= 33.223)
# colnames(fibroblasts) <- c("gene", "targeting_score")
# fibroblasts$cell_type <- "fibroblasts"
# 
# macrophages<- het_enriched[, c(1,15)]
# macrophages<- subset(macrophages, macrophages <= -285.752 | macrophages >= -105.057)
# colnames(macrophages) <- c("gene", "targeting_score")
# macrophages$cell_type <- "macrophages"
# 
# pericytes<- het_enriched[, c(1,16)]
# pericytes<- subset(pericytes, pericytes <= -242.113 | pericytes >= -37.853)
# colnames(pericytes) <- c("gene", "targeting_score")
# pericytes$cell_type <- "pericytes"
# 
# podocytes<- het_enriched[, c(1,17)]
# podocytes<- subset(podocytes, podocytes <= -139.110 | podocytes >= -2.302)
# colnames(podocytes) <- c("gene", "targeting_score")
# podocytes$cell_type <- "podocytes"
# 
# smcs<- het_enriched[, c(1,18)]
# smcs<- subset(smcs, smcs <= -140.379 | smcs >= -8.891)
# colnames(smcs) <- c("gene", "targeting_score")
# smcs$cell_type <- "smcs"
# 
# filtered_het <- bind_rows(Bcell, CDIC_typeA, CDIC_typeB, CDPC, DCT, DLH, LOH, PCTS1, PCTS2, PST, PT, endothelial, fibroblasts, macrophages, pericytes, podocytes, smcs)
# ```

Looking globally at differential targeting
# ```{r}
# filtered_het_wide <- pivot_wider(filtered_het, values_from = "targeting_score", names_from = "cell_type")
# 
# # positivies 
# 
# ## replace all negatives and NA with 0
# pos <- filtered_het_wide %>%
#   mutate_at(vars(-gene), ~replace(., is.na(.) | . < 0, 0))
# pos_non_zero_counts <- sapply(pos[-1], function(x) sum(x != 0))
# pos_non_zero_counts
# 
# ## sum diff targeting by cell type
# pos <- colSums(pos[,-1])
# 
# # negatives
# 
# ## replace all positives and NA with 0
# neg <- filtered_het_wide %>%
#   mutate_at(vars(-gene), ~replace(., is.na(.) | . > 0, 0))
# neg_non_zero_counts <- sapply(neg[-1], function(x) sum(x != 0))
# neg_non_zero_counts
# 
# 
# ## sum diff targeting by cell type
# neg <- colSums(neg[,-1])
# 
# 
# data <- as.data.frame(cbind(pos,neg))
# data$cell_type <- rownames(data) #rownames are cell type names
# data$pos_sum <- pos_non_zero_counts
# data$neg_sum <- neg_non_zero_counts
# 
# data <- data[order(data$pos, decreasing = TRUE),]
# 
# save(data, file = here("results/diff_targeting/global_diff_targeting_kidney.Rdata"))
# 
# #formatting data
# data_plot <- pivot_longer(data[,c(1:3)], cols = c(1,2), values_to = "sum")
# data_label <- pivot_longer(data[,c(4, 5)], cols = c(1,2), values_to = "sum")
# data_plot$num <- data_label$sum
# 
# data_plot$norm <- data_plot$sum/data_plot$num #normalize data by number of genes with enriched targeting
# write_csv(data_plot, file = here("results/diff_targeting/normalized_global_diff_targeting_kidney.csv"))
# 
# #setting plot order
# data_plot <- arrange(data_plot, desc(norm))
# data_plot$order <- seq(1:34)
# 
# png()
# ggsave(here("results/diff_targeting/total_differential_targeting_kidney.png"), dpi = 250)
# ggplot(data_plot, aes(x = norm, y = reorder(cell_type, norm))) +
#   theme_bw() +
#   geom_point(shape = 21, aes(fill = name, color = name, size = num)) +
#   scale_color_manual(values = c("black", "black"), guide = FALSE) +
#   scale_fill_manual(values = c("#e0da22", "purple"), labels = c("decreased in S858R condition", "increased in S858R condition")) +
#   labs(fill = "Differential gene targeting", size = "Number of Genes") +
#   theme(text = element_text(family = "Helvetica")) +
#   theme(
#     legend.position = "right",
#   ) +
#   ylab("Kidney Cortex Cell Type") +
#   xlab("Total Differential Targeting Score Normalized by Number of Genes") +
#   theme(axis.text.x = element_text(face = "bold", color = "black")) +
#   theme(axis.title.x = element_text(face = "bold", color = "black")) +
#   theme(axis.title.y = element_text(face = "bold", color = "black")) +
#   geom_text(aes(label = num), vjust = -0.8) +
#   theme(axis.text.y = element_text(face = "bold", color = "black")) +
#   theme(legend.title = element_text(face = "bold")) +
#   scale_y_discrete(expand=expansion(mult=c(0.05,0.05)))
# dev.off()
# ```

# ```{r calculating-prop-het-enriched-dt-genes-by-celltype}
# dims <- dim(het_enriched) # 20429 genes in this data
# dims
# 
# pos_prop <- (pos_non_zero_counts/dims[1]) * 100
# pos_prop
# 
# neg_prop <- (neg_non_zero_counts/dims[1]) * 100
# neg_prop
# 
# percentage_dt_genes <- as.data.frame(rbind(pos_prop, neg_prop))
# write_csv(percentage_dt_genes, file = here("results/diff_targeting/percentage_dt_genes_kidney.csv"))
# ```
Percent of genes with increased DT in S858R: 

Saving het_enriched without negatives for plotting:
# ```{r}
# het_enriched <- replace(het_enriched, het_enriched[, ] < 0, 0) # creating dataframe where the differential is enriched in the het condition
# save(het_enriched, file = here("results/diff_targeting/kidney_het_enriched_gene.Rdata"))
# ```

# ```{r calculate-ctrl-enriched-diff-targeting}
# # creating empty data frame
# diff_gene_targeting <- data.frame(matrix(NA, nrow = nrow(combined_gene_targeting), ncol = 1))
# colnames(diff_gene_targeting) <- "gene" # this will need to be gene or TF respectively
# diff_gene_targeting$gene <- combined_gene_targeting$gene # adding gene
# 
# # calc diff targeting
# cell_names <- colnames(gene_targeting_all_ctrl[, -1]) %>% sub("_ctrl.*", "", .) # all cell type prefixes except gene name, which should be first column in data
# for (i in cell_names) {
#   selected_columns <- names(combined_gene_targeting)[startsWith(names(combined_gene_targeting), i)]
#   # Check there are two columns with the specified prefix
#   if (length(selected_columns) == 2) {
#     diff_col <- combined_gene_targeting[[selected_columns[2]]] - combined_gene_targeting[[selected_columns[1]]] # ensure difference is `control - het` here
#     # Create a new column name
#     diff_colname <- paste0(i)
#     # Add the result to the result dataframe
#     diff_gene_targeting[[diff_colname]] <- diff_col
#   }
# }
# 
# ctrl_enriched <- replace(diff_gene_targeting, diff_gene_targeting[, ] < 0, 0) # creating dataframe where the differential is enriched in the ctrl condition
# save(ctrl_enriched, file = here("results/diff_targeting/kidney_ctrl_enriched_gene.Rdata"))
# ```

# ```{r visualizing-all-diff-gene-het-enriched}
# ## formatting input data
# data <- het_enriched
# names <- data$gene # add gene names as rownames
# data <- data[, -1, drop = FALSE] # drop gene column
# rownames(data) <- names
# # setting meta colname
# meta_colname <- "cell_type"
# # setting plot path
# plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_het_enriched_heatmap.png")
# # setting rowtitle
# rowtitle <- "genes"
# # setting columntitle
# plot_title <- "Differential Targeting of S858R enriched genes in Kidney Cortex"
# 
# targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
# ```

# ```{r visualizing-all-diff-gene-het-enriched-setbp1genes}
# # filtering for gene set
# data <- het_enriched[het_enriched$gene %in% setbp1_genes, ]
# 
# names <- data$gene # add names as rownames
# data <- data[, -1, drop = FALSE] # drop gene column
# rownames(data) <- names
# # setting meta colname
# meta_colname <- "cell_type"
# # setting plot path
# plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_het_Setbp1targets_enriched_heatmap.png")
# # setting rowtitle
# rowtitle <- "genes"
# # setting columntitle
# plot_title <- "Differential Gene Targeting of known targets of Setbp1 in S858R enriched genes of Kidney Cortex"
# 
# targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 2200)
# ```

# ```{r visualizing-all-diff-gene-ctrl-enriched}
# ## formatting input data
# data <- ctrl_enriched
# names <- data$gene # add gene names as rownames
# data <- abs(data[, -1])
# rownames(data) <- names
# # setting meta colname
# meta_colname <- "cell_type"
# # setting plot path
# plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_ctrl_enriched_heatmap.png")
# # setting rowtitle
# rowtitle <- "genes"
# # setting columntitle
# plot_title <- "Differential Targeting of Control enriched genes in kidney Cortex"
# 
# targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title)
# ```

# ```{r visualize-distribution-of-het-gene-difftargeting-scores}
# # het gene distribution
# exclude_column <- "gene"
# 
# pivoted <- pivot_longer(het_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched) != exclude_column))
# ggplot(data = pivoted, aes(x = targeting_score, group = cell_type, color = cell_type)) +
#   geom_density(adjust = 1.5, alpha = .4) +
#   ggtitle("Gene targeting score distribution in S8585R") +
#   scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
# summary(het_enriched)
# ```

# ```{r het-diff-gene-targeting-distribution-nonzero}
# # het gene distribution nonzero
# nonzero <- pivoted[pivoted$targeting_score != 0, ]
# png(
#   filename = here("results/diff_targeting/kidney_difftargeting_het_gene_distribution.png"),
#   width = 1000,
#   height = 500
# )
# ggplot(data = nonzero, aes(x = targeting_score, group = cell_type, color = cell_type)) +
#   geom_density(adjust = 1.5, alpha = .4) +
#   ggtitle("Gene differential targeting score distribution in S8585R") +
#   theme_bw() +
#   scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
# dev.off()
# 
# nonzero_long <- pivot_wider(nonzero, names_from = cell_type, values_from = targeting_score)
# summary(nonzero_long)
# 
# exclude_column <- "gene"
# pivoted <- pivot_longer(het_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(het_enriched) != exclude_column))
# summary(het_enriched)
# ```

# ```{r control-diff-gene-targeting-distribution}
# # control gene distribution
# exclude_column <- "gene"
# pivoted <- pivot_longer(ctrl_enriched, values_to = "targeting_score", names_to = "cell_type", cols = which(colnames(ctrl_enriched) != exclude_column))
# ggplot(data = pivoted, aes(x = abs(targeting_score), group = cell_type, color = cell_type)) +
#   geom_density(adjust = 1.5, alpha = .4) +
#   ggtitle("Gene targeting score distribution in Control") +
#   scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
# 
# summary(ctrl_enriched)
# 
# 
# nonzero <- pivoted[pivoted$targeting_score != 0, ]
# png(
#   filename = here("results/diff_targeting/kidney_difftargeting_ctrl_gene_distribution.png"),
#   width = 1000,
#   height = 500
# )
# ggplot(data = nonzero, aes(x = abs(targeting_score), group = cell_type, color = cell_type)) +
#   geom_density(adjust = 1.5, alpha = .4) +
#   ggtitle("Gene differential targeting score distribution in Control") +
#   theme_bw() +
#   scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
# dev.off()
# 
# nonzero_long <- pivot_wider(nonzero, names_from = cell_type, values_from = targeting_score)
# nonzero_long <- abs(nonzero_long[, which(colnames(nonzero_long) != exclude_column)])
# summary(nonzero_long)
# ```

# ```{r find-top-diff-targeted-genes-het-celltypes}
# cell_names <- colnames(het_enriched) %>% .[which(. != "gene")] # note: need to change for gene, grabbing cell type names
# cell_names
# 
# # rank genes by targeting for each cell type , find top 20
# gene_diff_het <- list() # creating empty list to store within
# 
# for (i in cell_names) {
#   rank_het <- het_enriched[, names(het_enriched) %in% c("gene", i)] %>%
#     .[order(.[i], decreasing = TRUE), ] %>%
#     mutate(rank = seq_len(nrow(.))) %>%
#     mutate(cell_type = i) %>%
#     slice(1:20) %>%
#     rename(targeting_score = i)
#   gene_diff_het[[i]] <- rank_het
# }
# 
# kidney_het_enriched_top_genes <- do.call(bind_rows, gene_diff_het) # collapsing list into single df using row binding
# 
# # rank genes by targeting for each cell type for all data
# gene_diff_het <- list() # creating empty list to store within
# 
# for (i in cell_names) {
#   rank_het <- het_enriched[, names(het_enriched) %in% c("gene", i)] %>%
#     .[order(.[i], decreasing = TRUE), ] %>%
#     mutate(rank = seq_len(nrow(.))) %>%
#     mutate(cell_type = i) %>%
#     rename(targeting_score = i)
#   gene_diff_het[[i]] <- rank_het
# }
# 
# kidney_het_enriched_all_genes <- do.call(bind_rows, gene_diff_het) # collapsing list into single df using row binding
# ```

# ```{r visualize-het-enriched-gene-top20-heatmap}
# ## formatting input data
# data <- kidney_het_enriched_top_genes[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
# data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
# data[is.na(data)] <- 0
# names <- data$gene # add gene names as rownames
# data <- data[, -1, drop = FALSE] # drop gene column
# rownames(data) <- names
# # setting meta colname
# meta_colname <- "cell_type"
# # setting plot path
# plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_top20_het_heatmap.png")
# # setting rowtitle
# rowtitle <- "genes"
# # setting columntitle
# plot_title <- "Differential Targeting of Top 20 Genes within Cell-types in Setbp1 S858R kidney Cortex"
# 
# targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 5000)
# ```

# ```{r find-top-diff-targeted-genes-ctrl-celltypes}
# cell_names <- colnames(ctrl_enriched) %>% .[which(. != "gene")] # note: need to change for gene, grabbing cell type names
# cell_names
# 
# # rank genes by targeting for each cell type , find top 20
# gene_diff_ctrl <- list() # creating empty list to store within
# 
# for (i in cell_names) {
#   rank_ctrl <- ctrl_enriched[, names(ctrl_enriched) %in% c("gene", i)] %>%
#     .[order(.[i], decreasing = TRUE), ] %>%
#     mutate(rank = seq_len(nrow(.))) %>%
#     mutate(cell_type = i) %>%
#     slice(1:20) %>%
#     rename(targeting_score = i)
#   gene_diff_ctrl[[i]] <- rank_ctrl
# }
# 
# kidney_ctrl_enriched_top_genes <- do.call(bind_rows, gene_diff_ctrl) # collapsing list into single df using row binding
# 
# # rank genes by targeting for each cell type for all data
# gene_diff_ctrl <- list() # creating empty list to store within
# 
# for (i in cell_names) {
#   rank_ctrl <- ctrl_enriched[, names(ctrl_enriched) %in% c("gene", i)] %>%
#     .[order(.[i], decreasing = TRUE), ] %>%
#     mutate(rank = seq_len(nrow(.))) %>%
#     mutate(cell_type = i) %>%
#     rename(targeting_score = i)
#   gene_diff_ctrl[[i]] <- rank_ctrl
# }
# 
# kidney_ctrl_enriched_all_genes <- do.call(bind_rows, gene_diff_ctrl) # collapsing list into single df using row binding
# ```

# ```{r visualize-ctrl-enriched-gene-top20-heatmap}
# ## formatting input data
# data <- kidney_ctrl_enriched_top_genes[, c("gene", "targeting_score", "cell_type"), drop = FALSE]
# data <- pivot_wider(data, names_from = c("cell_type"), values_from = "targeting_score", names_repair = "minimal")
# data[is.na(data)] <- 0
# names <- data$gene # add gene names as rownames
# data <- data[, -1, drop = FALSE] # drop gene column
# rownames(data) <- names
# # setting meta colname
# meta_colname <- "cell_type"
# # setting plot path
# plot_path <- here("results/diff_targeting/kidney_gene_DIFFtargeting_top20_ctrl_heatmap.png")
# # setting rowtitle
# rowtitle <- "genes"
# # setting columntitle
# plot_title <- "Differential Targeting of Top 20 Genes within Cell-types in Setbp1 S858R kidney Cortex"
# 
# targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, height = 5000)
# ```

```{r}
fptm <- proc.time() - ptm
fptm[3] / 60
```


```{r}
# run style
style_file(here("src/gene_targeting/01_gene_targting.Rmd"))
# lintr was run as well
```


```{r}
sessionInfo()
```

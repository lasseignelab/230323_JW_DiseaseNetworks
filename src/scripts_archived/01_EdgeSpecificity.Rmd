---
title: "01_EdgeSpecificity"
author: "TC Howton"
date: "2023-04-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose
This RMarkdown identifies edge specificity for all 38 Gtex PANDA tissue-specific
networks for the ADPKD- and ARPKD-associated genes.

### Load Packages
```{r LoadPackages}
suppressPackageStartupMessages({
  library(here)
  library(ggplot2)
  library(dplyr)
  library(ComplexHeatmap)
  library(circlize)
})

source(
  here(
    "src",
    "functions.R"
  )
)
```

### Load Data
Glass table of tissue specific edges from here: https://sites.google.com/a/channing.harvard.edu/kimberlyglass/tools/gtex-networks

```{r LoadData}
#imported in Environment as STable1_GTEx_TSInfo_Edges from STable1_GTEx_TSInfo_Edges.txt 
STable1_GTEx_TSInfo_Edges <- read.delim2(
  paste0(
    "/data/",
    "project/",
    "lasseigne_lab/",
    "DATASET_dir/",
    "GtexPanda/",
    "STable1_GTEx_TSInfo_Edges.txt"
  )
)

pkd_associated_genes <- read.csv(
  here(
    "data",
    "pkd_associated_genes.csv"
  )
)
dim(STable1_GTEx_TSInfo_Edges) #6,570,096 rows 5 cols
dim(pkd_associated_genes) # 14 rows 3 cols

# Add Ensembl IDs for each gene
pkd_associated_genes$ensemblID <- c(
  "ENSG00000008710", 
  "ENSG00000118762", 
  "ENSG00000089597", 
  "ENSG00000170927", 
  "ENSG00000158163", 
  "ENSG00000205795", 
  "ENSG00000103197", 
  "ENSG00000275410", 
  "ENSG00000185499", 
  "ENSG00000169344", 
  "ENSG00000119509", 
  "ENSG00000113971", 
  "ENSG00000157796", 
  "ENSG00000134086"
)

# Correct spelling errors in the gene symbols
pkd_associated_genes$gene[[8]] <- "HNF1B"
pkd_associated_genes$gene[[5]] <- "DZIP1L"

```

```{r TissueLists}
tissueTypes<-unlist(strsplit(STable1_GTEx_TSInfo_Edges$Tissues, ","))
tissueTypes <- unique(tissueTypes)
tissueTypesWOnone <- tissueTypes[tissueTypes != "none"]
```

### Check to see if any of our genes are TFs

```{r TFandTargetSums}
for (i in 1:length(pkd_associated_genes$gene)) {
  gene <- pkd_associated_genes$gene[[i]]
  print(
    paste0(
      gene, 
      " - ",
      sum(STable1_GTEx_TSInfo_Edges$TF == gene)
    )
  )
}

# "PKD1 - 0"
# "PKD2 - 0"
# "GANAB - 0"
# "PKHD1 - 0"
# "DZIP1L - 0"
# "CYS1 - 0"
# "TSC2 - 0"
# "HNF1B - 9210"
# "MUC1 - 0"
# "UMOD - 0"
# "NPHP2 - 0"
# "NPHP3 - 0"
# "NPHP13 - 0"
# "VHL - 0"

# Check to make sure all the pkd genes are targets
for (i in 1:length(pkd_associated_genes$ensemblID)) {
  ID <- pkd_associated_genes$ensemblID[[i]]
  gene <- pkd_associated_genes$gene[[i]]
  print(
    paste0(
      gene,
      " - ",
      ID,
      " - ",
      sum(STable1_GTEx_TSInfo_Edges$TargetGene == ID)
    )
  )
}

# "PKD1 - ENSG00000008710 - 316"
# "PKD2 - ENSG00000118762 - 254"
# "GANAB - ENSG00000089597 - 184"
# "PKHD1 - ENSG00000170927 - 309"
# "DZIP1L - ENSG00000158163 - 155"
# "CYS1 - ENSG00000205795 - 72"
# "TSC2 - ENSG00000103197 - 456"
# "HNF1B - ENSG00000275410 - 0"
# "MUC1 - ENSG00000185499 - 290"
# "UMOD - ENSG00000169344 - 383"
# "NPHP2 - ENSG00000119509 - 196"
# "NPHP3 - ENSG00000113971 - 244"
# "NPHP13 - ENSG00000157796 - 462"
# "VHL - ENSG00000134086 - 158"

# Filter out HNF1-B because it is not a target gene
pkd_target_genes <-pkd_associated_genes[pkd_associated_genes$ensemblID != "ENSG00000275410",]
pkd_gene_symbols <- pkd_target_genes$gene
pkd_target_genes <- pkd_target_genes$ensemblID
```
### Calculate edge specficicity proportions per pkd gene

```{r CalculateProportions}
proportions_per_gene <- calculate_proportions(
  gene_list = pkd_target_genes,
  data_table = STable1_GTEx_TSInfo_Edges,
  tissue_types = tissueTypesWOnone
)
```

``` {r FormatProportions}
formatted_proportions <- data.frame(
      matrix(
        ncol = length(pkd_target_genes), 
        nrow = length(tissueTypesWOnone)
      )
    )

rownames(formatted_proportions) <- tissueTypesWOnone
colnames(formatted_proportions) <- pkd_target_genes

for (i in 1:length(proportions_per_gene)) {
  gene <- pkd_target_genes[i]
  formatted_proportions[[gene]] <- proportions_per_gene[[gene]]
}
```
### Save proportions
```{r SaveProportions}
saveRDS(
  proportions_per_gene,
  here(
    "data",
    "EdgeProportionsPerGenePerTissue.rds"
  )
)

saveRDS(
  formatted_proportions,
  here(
    "data",
    "FormattedProportions.rds"
  )
)
```

### Permutation testing for p values
```{r PermutationTest}
# Set up p value data frame
pval_df <- data.frame(
      matrix(
        ncol = length(pkd_target_genes), 
        nrow = length(tissueTypesWOnone)
      )
    )

rownames(pval_df) <- tissueTypesWOnone
colnames(pval_df) <- pkd_target_genes

# Permutation test to calculate the p value for each gene of interest per tissue
for (i in 1:length(pkd_target_genes)) {
  p_vals <- permutation_test(
    data_table = STable1_GTEx_TSInfo_Edges,
    tissue_types = tissueTypesWOnone,
    gene_oi = pkd_target_genes[i],
    nperm = 999
  )
  pval_df[,i] <- p_vals
}
```

```{r SavePValues}
saveRDS(
  pval_df,
  here(
    "data",
    "PValuesDataFrame.rds"
  )
)
```



### Format proportions for plotting
```{r FormatProportions}
formatted_proportions <- list()
for (i in 1:length(names(proportions_per_gene))) {
  gene <- names(proportions_per_gene)[[i]]
  gene_dataframe <- as.data.frame(proportions_per_gene[[gene]])
  colnames(gene_dataframe) <- "Proportions"
  gene_dataframe$Tissues <- rownames(gene_dataframe)
  formatted_proportions[[gene]] <- gene_dataframe
}


# test <- as.data.frame(proportions_per_gene[[1]])
# colnames(test) <- "Proportions"
# test$Tissues <- rownames(test)
```

### Plot proportions
```{r PlotIndividualProportions}

###################TODO fix the function and add p values####################

pdf(
  here(
    "results",
    "EdgeSpecificityProportionsByGene.pdf"
  )
)
for (i in 1:length(names(formatted_proportions))) {
  gene <- names(formatted_proportions)[[i]]
  print(gene)
  plot <- ggplot(
    formatted_proportions[[gene]],
    aes(
      x = Proportions,
      y = Tissues,
    )
  ) +
    geom_point(
      col = "tomato2",
      size = 3
    ) +
    xlim(0, 1) +
    labs(
      title = paste0(
        "Proportions of Specific Edges Per Tissue - ",
        pkd_associated_genes$gene[[i]]),
    )
  print(plot)
}
dev.off()

test_gene <- pkd_target_genes[1]
ggplot(
    formatted_proportions,
    aes(
      x = ENSG00000008710,
      y = rownames(formatted_proportions),
    )
  ) +
    geom_point(
      col = "tomato2",
      size = 3
    ) +
    xlim(0, 1) +
    labs(
      title = paste0(
        "Proportions of Specific Edges Per Tissue - ",
        pkd_gene_symbols[1]),
    )
```

### Heatmap Visualization
```{r HeatmapVisualization}
proportions_matrix <- as.matrix(formatted_proportions)
colnames(proportions_matrix) <- pkd_gene_symbols

pval_mat <- as.matrix(pval_df)

col_fun = colorRamp2(
  c(0, 0.4),
  c("white",
    "blue")
)
png(
  here(
    "results",
    "ProportionsHeatmap.png"
  )
)
Heatmap(
  proportions_matrix,
  show_row_dend = FALSE,
  show_column_dend = FALSE,
  name = "Proportion",
  col = col_fun,
  layer_fun = function(j, i, x, y, width, height, fill) {
        v = pindex(pval_mat, i, j)
        l = v < 0.05
        gb = textGrob("*")
        gb_h = convertHeight(grobHeight(gb), "mm")
        grid.text(sprintf("*"), x[l], y[l] - gb_h*0.3, gp = gpar(fontsize = 15))
  }
)
dev.off()
```


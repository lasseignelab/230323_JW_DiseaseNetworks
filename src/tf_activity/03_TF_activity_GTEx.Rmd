---
title: "03_TF_activity_GTEx"
author: "Jordan Whitlock"
date: '2023-06-07'
output: html_document
---
# Setup
```{r load-libraries-functions}
set.seed(2178)
library(decoupleR)
library(dplyr)
library(tibble)
library(tidyr)
library(styler)
library(ComplexHeatmap)
library(ggrepel)
library(readr)
library(here)
source(here("src/functions.R"))
ptm <- proc.time()
```

```{r load-geneset}
# load in gene set for Setbp1
setbp1_genes <- read.csv(here("results/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")
setbp1_genes <- toupper(setbp1_genes)
```

```{r load-CollecTRI-prior-mouse}
collectri <- read_csv(here("data/human_prior_tri.csv"))
```

```{r load-decoupleR-results}
files <- list.files(here("results/decoupleR"), full.names = TRUE)
files

name_acts_list <- list()

# calculating the average TF activity score per gene within eac cell type across all cells
for (i in files) {
  load(i) # object name: acts
  name <- basename(i)
  name <- gsub("_acts.RData", "", name) # grab only portion of name before '_acts.RData'
  name_acts <- acts
  name_acts$tissue <- sub("gtex_", "", name)
  name_acts_list[[name]] <- name_acts
  print(paste0("loaded acts for ", name))
}

# combining
acts <- bind_rows(name_acts_list)
acts[1:6, 1:6]
```


```{r scale-and-summarize-decoupleR-results}
acts$scaled <- scale(acts$score)
summarize_acts <- acts %>%
  group_by(source, tissue) %>%
  summarise(mean = mean(scaled))

hist(summarize_acts$mean)
```

```{r pivot-data}
data <- summarize_acts %>%
  pivot_wider(
    id_cols = "source", names_from = "tissue",
    values_from = "mean"
  ) %>%
  column_to_rownames("source")

data <- as.matrix(data)
```

```{r filter-for-geneset}
data <- data[rownames(data) %in% setbp1_genes, ]
```

```{r plotting-geneset-TFs}
# Choose color palette
palette_length <- 100
my_color <- colorRampPalette(c("Darkblue", "white", "red"))(palette_length)

my_breaks <- c(
  seq(-3, 0, length.out = ceiling(palette_length / 2) + 1),
  seq(0.05, 3, length.out = floor(palette_length / 2))
)

png(
  filename = here("results/tf_activity/gtex_setbp1_geneset.png"),
  width = 2000,
  height = 1500,
  res = 250
)
# Plot
pheatmap(data, border_color = NA, color = my_color, breaks = my_breaks)
dev.off()
```

```{r processing-time}
fptm <- proc.time() - ptm
fptm[3] / 60
```
elapsed 
 0.5167

```{r style-file}
# run style
style_file(here("src/tf_activity/03_TF_activity_GTEx.Rmd")) # commented out after being run once
# lintr was run as well
```

```{r session-info}
sessionInfo()
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] here_1.0.1            readr_2.1.4           ggrepel_0.9.3         ggplot2_3.4.1         ComplexHeatmap_2.10.0 styler_1.9.0         
 [7] tidyr_1.3.0           tibble_3.1.8          dplyr_1.1.0           decoupleR_2.0.1      

loaded via a namespace (and not attached):
 [1] circlize_0.4.15     shape_1.4.6         GetoptLong_1.0.5    tidyselect_1.2.0    xfun_0.37           purrr_1.0.1        
 [7] lattice_0.20-45     colorspace_2.1-0    vctrs_0.5.2         generics_0.1.3      stats4_4.1.3        utf8_1.2.3         
[13] rlang_1.0.6         R.oo_1.25.0         pillar_1.8.1        glue_1.6.2          withr_2.5.0         R.utils_2.12.2     
[19] bit64_4.0.5         BiocGenerics_0.40.0 RColorBrewer_1.1-3  matrixStats_0.63.0  foreach_1.5.2       R.cache_0.16.0     
[25] lifecycle_1.0.3     munsell_0.5.0       gtable_0.3.1        R.methodsS3_1.8.2   GlobalOptions_0.1.2 codetools_0.2-18   
[31] knitr_1.42          tzdb_0.3.0          IRanges_2.28.0      doParallel_1.0.17   parallel_4.1.3      fansi_1.0.4        
[37] Rcpp_1.0.10         scales_1.2.1        S4Vectors_0.32.4    vroom_1.6.1         bit_4.0.5           hms_1.1.2          
[43] rjson_0.2.21        png_0.1-8           digest_0.6.31       rprojroot_2.0.3     clue_0.3-64         cli_3.6.0          
[49] tools_4.1.3         magrittr_2.0.3      cluster_2.1.2       crayon_1.5.2        pkgconfig_2.0.3     ellipsis_0.3.2     
[55] Matrix_1.5-3        rstudioapi_0.14     iterators_1.0.14    R6_2.5.1            compiler_4.1.3     

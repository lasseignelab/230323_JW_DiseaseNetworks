---
title: "03_TF_activity_GTEx"
author: "Jordan Whitlock"
date: '2023-06-07'
output: html_document
---
# Setup
```{r load-libraries-functions}
set.seed(2178)
library(decoupleR)
library(dplyr)
library(tibble)
library(stringr)
library(tidyr)
library(circlize)
library(styler)
library(ComplexHeatmap)
library(ggrepel)
library(readr)
library(here)
source(here("src/functions.R"))
ptm <- proc.time()
```

```{r load-geneset}
# load in gene set for Setbp1
setbp1_genes <- read.csv(here("results/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1")
setbp1_genes <- toupper(setbp1_genes)
```

```{r load-CollecTRI-prior-mouse}
collectri <- read_csv(here("data/human_prior_tri.csv"))
```

```{r load-decoupleR-results}
files <- list.files(here("results/decoupleR"), full.names = TRUE)
files

name_acts_list <- list()

# calculating the average TF activity score per gene within eac cell type across all cells
for (i in files) {
  load(i) # object name: acts
  name <- basename(i)
  name <- gsub("_acts.RData", "", name) # grab only portion of name before '_acts.RData'
  name_acts <- acts
  name_acts$tissue <- sub("gtex_", "", name)
  name_acts_list[[name]] <- name_acts
  print(paste0("loaded acts for ", name))
}

# combining
acts <- bind_rows(name_acts_list)
acts[1:6, 1:6]
```


```{r scale-and-summarize-decoupleR-results}
acts$scaled <- scale(acts$score)
summarize_acts <- acts %>%
  group_by(source, tissue) %>%
  summarise(mean = mean(scaled))

hist(summarize_acts$mean)
```

```{r pivot-data}
data <- summarize_acts %>%
  pivot_wider(
    id_cols = "source", names_from = "tissue",
    values_from = "mean"
  ) %>%
  column_to_rownames("source")

data <- as.matrix(data)
```

```{r filter-for-geneset}
data <- data[rownames(data) %in% setbp1_genes, ]
```

```{r}
# cleaning up names for plotting
colnames(data) <- gsub("_", " ", colnames(data))
colnames(data) <- str_to_title(colnames(data))

# grab meta data for plot:
meta <- as.data.frame(colnames(data))

rownames(meta) <- meta$`colnames(data)`
colnames(meta) <- c("tissue")

# convert dataframe to matrix
mat <- as.matrix(data)

# plot heatmap
# Heatmap
col_fun <- colorRamp2(seq(min(mat), max(mat), length = 4), c("#8C5209", "white", "#93C4BE", "#35978F"))
png(
  filename = here("results/tf_activity/tf_activity_geneset_complexheatmap.png"),
  width = 3000,
  height = 3000,
  res = 300
)
Heatmap(mat,
  col = col_fun,
  heatmap_legend_param = list(title = "TF Activity", at = c(-5, 0, 5, 10)),
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  column_order = NULL,
  show_row_dend = TRUE,
  show_column_dend = TRUE,
  row_names_gp = gpar(fontface = "bold", fontfamily = "Helvetica"),
  row_title_gp = gpar(fontface = "bold"),
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_gp = gpar(fontface = "bold", fontfamily = "Helvetica"),
  use_raster = TRUE,
  raster_device = c("png"),
  bottom_annotation = NULL,
  top_annotation = NULL
)
dev.off()
```


```{r processing-time}
fptm <- proc.time() - ptm
fptm[3] / 60
```
elapsed 
 0.5167

```{r style-file}
# run style
style_file(here("src/tf_activity/03_TF_activity_GTEx.Rmd")) # commented out after being run once
# lintr was run as well
```

```{r session-info}
sessionInfo()
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] here_1.0.1            readr_2.1.4           ggrepel_0.9.3        
 [4] ggplot2_3.4.1         ComplexHeatmap_2.10.0 styler_1.9.0         
 [7] circlize_0.4.15       tidyr_1.3.0           stringr_1.5.0        
[10] tibble_3.1.8          dplyr_1.1.0           decoupleR_2.0.1      

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.10         lattice_0.20-45     png_0.1-8           rprojroot_2.0.3    
 [5] digest_0.6.31       foreach_1.5.2       utf8_1.2.3          plyr_1.8.8         
 [9] R6_2.5.1            stats4_4.1.3        evaluate_0.20       pillar_1.8.1       
[13] GlobalOptions_0.1.2 rlang_1.0.6         rstudioapi_0.14     S4Vectors_0.32.4   
[17] R.utils_2.12.2      R.oo_1.25.0         GetoptLong_1.0.5    Matrix_1.5-3       
[21] rmarkdown_2.20      bit_4.0.5           munsell_0.5.0       compiler_4.1.3     
[25] xfun_0.37           pkgconfig_2.0.3     BiocGenerics_0.40.0 shape_1.4.6        
[29] htmltools_0.5.4     tidyselect_1.2.0    IRanges_2.28.0      codetools_0.2-18   
[33] matrixStats_0.63.0  fansi_1.0.4         crayon_1.5.2        tzdb_0.3.0         
[37] withr_2.5.0         R.methodsS3_1.8.2   gtable_0.3.1        lifecycle_1.0.3    
[41] magrittr_2.0.3      scales_1.2.1        vroom_1.6.1         cli_3.6.0          
[45] stringi_1.7.12      reshape2_1.4.4      doParallel_1.0.17   ellipsis_0.3.2     
[49] generics_0.1.3      vctrs_0.5.2         rjson_0.2.21        RColorBrewer_1.1-3 
[53] iterators_1.0.14    tools_4.1.3         bit64_4.0.5         R.cache_0.16.0     
[57] glue_1.6.2          purrr_1.0.1         hms_1.1.2           yaml_2.3.7         
[61] fastmap_1.1.1       parallel_4.1.3      clue_0.3-64         colorspace_2.1-0   
[65] cluster_2.1.2       knitr_1.42  
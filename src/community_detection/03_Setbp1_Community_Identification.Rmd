---
title: "03_Setbp1_Community_Identification"
author: "Jordan Whitlock"
date: '2023-06-28'
output: html_document
---

Goal: Determine what Community Number TF and gene Setbp1 is contained in for every single cell type in both tissues. This is needed for Jaccard similarity comparisons between SETBP1 communities in following script.


```{r loading-libraries-seed-proctime}
set.seed(2178)
library(here)
library(ggplot2)
library(tidyverse)
library(styler)
library(dplyr)
ptm <- proc.time()
```

```{r loading-geneset}
# load in gene set for SETBP1 (converted by LW)
setbp1_genes <- read.csv(here("data/SETBP1_Targets/setbp1_targets_geneconversions.csv"))
setbp1_genes <- setbp1_genes$name %>% as.vector()
```

```{r diff-comm-members-of-setbp1}
pattern <- "_membership.RData"
directory <- here("results/condor/membership")
files <- list.files(directory, pattern = paste0(".*", pattern), full.names = TRUE)
toevaluate <- sub("\\_membership.RData$", "", basename(files)) %>%
  sub("^.*gtex_", "", .)

condor_list <- list()

for (t in 1:length(toevaluate)) {
  # Load condor communities
  readcomms <- paste(here("results/condor/membership/gtex_"),
    toevaluate[t], "_membership.RData",
    sep = ""
  )
  load(readcomms) # environment variable called condor_memb

  # wrangle condor communities into dataframe
  data <- as.data.frame(condor_memb)

  # creating column for gene/TF name:
  # Move row names to a column called "name"
  data$name <- rownames(data)

  # Split the column into two separate columns
  data <- data %>%
    separate(name, into = c("name", "entity"), sep = "_", remove = FALSE)

  # Replace "_A" with "TF" and "_B" with "gene" in the second column
  data$entity <- ifelse(data$entity == "A", "TF", "gene")

  # Reset row names to NULL
  rownames(data) <- NULL
  # store in list object
  condor_list[[t]] <- data

  # clean up environment
  rm(condor_memb)
  rm(data)
}

names(condor_list) <- toevaluate

save(condor_list, file = here("results/condor/condor_list.Rdata"))
```

```{r diff-comm-members-of-setbp1-targets}
# Subset each dataframe for Setbp1 gene set in the list and annotate with the list name
subset_dfs <- lapply(names(condor_list), function(list_name) {
  df <- condor_list[[list_name]]
  subset_df <- df[df$name %in% setbp1_genes, ]
  subset_df$tissue_type <- list_name
  return(subset_df)
})

# Bind all subset dataframes into a single dataframe
setbp1_communities <- bind_rows(subset_dfs)

# save
write.csv(setbp1_communities,
  file = here("results/condor/gtex_communities_setbp1_geneset.csv"),
  row.names = FALSE
)
```


```{r investigating-community-size}
data <- read.csv(here("results/condor/gtex_communities_setbp1_geneset.csv"))

subset_names <- data[data$name == "SETBP1" & data$entity == "TF", ]
subset_names <- subset_names %>% unite(tissue_comm, tissue_type, condor_memb, sep = "_")
subset_names <- subset_names$tissue_comm

combo_name <- data %>% unite(tissue_comm, tissue_type, condor_memb, sep = "_")
combo_name <- combo_name$tissue_comm

data$combo_name <- combo_name

data <- data[data$combo_name %in% subset_names, ]

summary_data <- data %>%
  group_by(tissue_type, condor_memb) %>%
  summarize(count = n())
summary_data

comm_data <- summary_data %>%
  unite(tissue_comm, tissue_type, condor_memb, sep = "_")
comm_data$condor_memb <- as.character(summary_data$condor_memb)

# modifying for plotting
comm_data$tissue <- str_replace(comm_data$tissue_comm, "_\\d+$", "")

comm_data <- comm_data %>%
  mutate(tissue_comm = reorder(tissue_comm, -count))

comm_data$tissue_comm <- col <- sub("_[^_]*$", "", comm_data$tissue_comm)
comm_data$tissue_comm <- str_to_title(comm_data$tissue_comm) %>% gsub("_", " ", .)

# reorder by community size and plot

png(
  filename = here("results/condor/SETBP1_community_size.png"),
  width = 2000,
  height = 2000,
  res = 300
)
comm_data %>%
  arrange(count) %>%
  mutate(name = factor(tissue_comm, levels = tissue_comm)) %>%
  ggplot(aes(y = name, x = count, fill = condor_memb)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("#D3B1C5", "#A468A9", "#533180", "#2C1D6C")) +
  theme_bw() +
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(color = "black")) +
  theme(axis.text.y = element_text(color = "black")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.title.y = element_text(face = "bold")) +
  theme(axis.title.x = element_text(face = "bold")) +
  labs(x = "SETBP1 Community Size", y = "GTEx Tissue", fill = "Community Number") +
  ggtitle("SETBP1 Community Size across GTEx Tissues") +
  theme(
    title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0, size = 20),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  )

dev.off()
```

# filter for SETBP1 to determine its community number as a TF for each cell type for Jaccard Index analysis
```{r}
# Filter rows where "name" is "Setbp1"
filtered_df <- setbp1_communities %>%
  filter(name == "SETBP1" & entity == "TF")

# Group by "tissue_type" and output values in "condor_memb" column
output <- filtered_df %>%
  group_by(tissue_type) %>%
  summarize(com_value = unique(condor_memb))

# Print the output
print(output) # Setbp1 is in community 1 for all cell types in cortex

write.csv(output,
  file = here("results/condor/communitynumber_setbp1_TF.csv"),
  row.names = FALSE
)
```
SETBP1 TF Communities:		
ADIPOSE_TISSUE	1			
ADRENAL_GLAND	1			
BLADDER	2			
BLOOD	1			
BLOOD_VESSEL	3			
BONE_MARROW	3			
BRAIN	1			
BREAST	1			
CERVIX_UTERI	2			
COLON	1			
ESOPHAGUS	2			
FALLOPIAN_TUBE	1			
HEART	1			
KIDNEY	1			
LIVER	1			
LUNG	2			
MUSCLE	1			
NERVE	1			
OVARY	1			
PANCREAS	1			
PITUITARY	1			
PROSTATE	1			
SALIVARY_GLAND	1			
SKIN	4			
SMALL_INTESTINE	1			
SPLEEN	1			
STOMACH	1			
TESTIS	3			
THYROID	1			
UTERUS	2			
VAGINA	1	

# generate SETBP1 TF community pairing vector for Jaccard similarity comparison analysis
```{r}
# remove underscores in tissue_type column (example: "ADIPOSE_TISSUE", "ADIPOSETISSUE") for downstream analysis
filtered_df$tissue_type <- gsub("_", "", filtered_df$tissue_type)

# create column containing `tissue_type`_`condor_memb`
filtered_df <- filtered_df %>%
  mutate(barcode = paste(tissue_type, condor_memb, sep = "_"))

# Get all possible combinations of row values
combinations <- combn(filtered_df$barcode, 2, FUN = function(x) paste(x, collapse = "_"))

# Store combinations in a vector
combinations_vector_setbp1_TF <- unlist(combinations)

# Print the resulting vector
print(combinations_vector_setbp1_TF)

# save vector for Jaccard similarity
save(combinations_vector_setbp1_TF,
  file = here("results/condor/setbp1_TF_combinations_vector.Rdata")
)
```

```{r processing-time}
fptm <- proc.time() - ptm
fptm[3] / 60
```
elapsed 
2.17615 

```{r style-file}
# run style
style_file(here("src/community_detection/03_Setbp1_Community_Identification.Rmd")) # commented out after being run once
# lintr was run as well
```

```{r session-info}
sessionInfo()
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] styler_1.9.0    lubridate_1.9.2 forcats_1.0.0   stringr_1.5.0   dplyr_1.1.0     purrr_1.0.1     readr_2.1.4     tidyr_1.3.0     tibble_3.1.8   
[10] ggplot2_3.4.1   tidyverse_2.0.0 here_1.0.1     

loaded via a namespace (and not attached):
 [1] pillar_1.8.1      compiler_4.1.3    R.utils_2.12.2    R.methodsS3_1.8.2 tools_4.1.3       digest_0.6.31     R.cache_0.16.0    timechange_0.2.0 
 [9] lifecycle_1.0.3   gtable_0.3.1      pkgconfig_2.0.3   rlang_1.0.6       cli_3.6.0         rstudioapi_0.14   xfun_0.37         withr_2.5.0      
[17] knitr_1.42        generics_0.1.3    vctrs_0.5.2       hms_1.1.2         rprojroot_2.0.3   grid_4.1.3        tidyselect_1.2.0  glue_1.6.2       
[25] R6_2.5.1          fansi_1.0.4       tzdb_0.3.0        magrittr_2.0.3    scales_1.2.1      ellipsis_0.3.2    colorspace_2.1-0  utf8_1.2.3       
[33] stringi_1.7.12    munsell_0.5.0     R.oo_1.25.0    

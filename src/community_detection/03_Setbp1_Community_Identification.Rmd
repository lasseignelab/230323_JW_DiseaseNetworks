---
title: "02_Setbp1_Community_Identification"
author: "Jordan Whitlock"
date: '2023-06-28'
output: html_document
---

Goal: Determine what Community Number TF Setbp1 is contained in for every single cell type in both tissues. This is needed for JI comparisons between Sebtp1 communities in following script.

```{r}
set.seed(2178)
library(here)
library(tidyverse)
library(styler)
library(dplyr)
ptm <- proc.time()
```

```{r}
# load in gene set for Setbp1
setbp1_genes <- read.csv(here("results/setbp1_targets.csv"))
setbp1_genes <- setbp1_genes[, -1] %>% as.vector()
setbp1_genes <- append(setbp1_genes, "Setbp1") %>% toupper()
```

```{r cortex-diff-mod-comm-members-of-setbp1}
pattern <- "_membership.RData"
directory <- here("results/condor/membership")
files <- list.files(directory, pattern = paste0(".*", pattern), full.names = TRUE)
toevaluate <- sub("\\_membership.RData$", "", basename(files)) %>%
  sub("^.*gtex_", "", .)

condor_list <- list()

for (t in 1:length(toevaluate)) {
  # Load condor communities
  readcomms <- paste(here("results/condor/membership/gtex_"),
                     toevaluate[t], "_membership.RData",
                     sep = "")
  load(readcomms) # environment variable called condor_memb

  # wrangle condor communities into dataframe
  data <- as.data.frame(condor_memb)

  # creating column for gene/TF name:
  # Move row names to a column called "name"
  data$name <- rownames(data)

  # Split the column into two separate columns
  data <- data %>%
    separate(name, into = c("name", "entity"), sep = "_", remove = FALSE)

  # Replace "_A" with "TF" and "_B" with "gene" in the second column
  data$entity <- ifelse(data$entity == "A", "TF", "gene")

  # Reset row names to NULL
  rownames(data) <- NULL
  # store in list object
  condor_list[[t]] <- data

  # clean up environment
  rm(condor_memb)
  rm(data)
}

names(condor_list) <- toevaluate
```

```{r cortex-diff-mod-comm-members-of-setbp1-targets}
# Subset each dataframe for Setbp1 gene set in the list and annotate with the list name
subset_dfs <- lapply(names(condor_list), function(list_name) {
  df <- condor_list[[list_name]]
  subset_df <- df[df$name %in% setbp1_genes, ]
  subset_df$tissue_type <- list_name
  return(subset_df)
})

# Bind all subset dataframes into a single dataframe
setbp1_communities <- bind_rows(subset_dfs)

# save
write.csv(setbp1_communities, 
          file = here("results/condor/gtex_communities_setbp1_geneset.csv"),
          row.names = FALSE)
```

# filter for Setbp1 to determine its community number as a TF for each cell type for Jaccard Index analysis
```{r}
# Filter rows where "name" is "Setbp1"
filtered_df <- setbp1_communities %>%
  filter(name == "SETBP1" & entity == "TF")

# Group by "tissue_type" and output values in "condor_memb" column
output <- filtered_df %>%
  group_by(tissue_type) %>%
  summarize(com_value = unique(condor_memb))

# Print the output
print(output) # Setbp1 is in community 1 for all cell types in cortex
```
SETBP1 TF Communities:		
ADIPOSE_TISSUE	1			
ADRENAL_GLAND	1			
BLADDER	2			
BLOOD	1			
BLOOD_VESSEL	3			
BONE_MARROW	3			
BRAIN	1			
BREAST	1			
CERVIX_UTERI	2	

# filter for Setbp1 to determine its community number as a gene for each cell type for Jaccard Index analysis
```{r}
# Filter rows where "name" is "Setbp1"
filtered_df <- setbp1_communities %>%
  filter(name == "SETBP1" & entity == "gene")

# Group by "tissue_type" and output values in "condor_memb" column
output <- filtered_df %>%
  group_by(tissue_type) %>%
  summarize(com_value = unique(condor_memb))

# Print the output
print(output) # Setbp1 is in community 1 for all cell types in cortex
```
SETBP1 gene Communities:
ADIPOSE_TISSUE	3			
ADRENAL_GLAND	2			
BLADDER	3			
BLOOD	2			
BLOOD_VESSEL	2			
BONE_MARROW	2			
BRAIN	2			
BREAST	2			
CERVIX_UTERI	3			
COLON	2			
ESOPHAGUS	2			
FALLOPIAN_TUBE	2			
HEART	2			
KIDNEY	2			
LIVER	2			
LUNG	3			
MUSCLE	3			
NERVE	2			
OVARY	2			
PANCREAS	2			
PITUITARY	3			
PROSTATE	2			
SALIVARY_GLAND	2			
SKIN	3			
SMALL_INTESTINE	2			
SPLEEN	2			
STOMACH	2			
TESTIS	2			
THYROID	3			
UTERUS	2			
VAGINA	2	

```{r processing-time}
fptm <- proc.time() - ptm
fptm[3] / 60
```
elapsed 
0.1548 


```{r style-file}
# run style
style_file(here("src/community_detection/03_Setbp1_Community_Identification.Rmd")) # commented out after being run once
# lintr was run as well
```

```{r session-info}
sessionInfo()
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] styler_1.9.0    lubridate_1.9.2 forcats_1.0.0   stringr_1.5.0   dplyr_1.1.0     purrr_1.0.1     readr_2.1.4     tidyr_1.3.0     tibble_3.1.8   
[10] ggplot2_3.4.1   tidyverse_2.0.0 here_1.0.1     

loaded via a namespace (and not attached):
 [1] pillar_1.8.1      compiler_4.1.3    R.utils_2.12.2    R.methodsS3_1.8.2 tools_4.1.3       digest_0.6.31     R.cache_0.16.0    timechange_0.2.0 
 [9] lifecycle_1.0.3   gtable_0.3.1      pkgconfig_2.0.3   rlang_1.0.6       cli_3.6.0         rstudioapi_0.14   xfun_0.37         withr_2.5.0      
[17] knitr_1.42        generics_0.1.3    vctrs_0.5.2       hms_1.1.2         rprojroot_2.0.3   grid_4.1.3        tidyselect_1.2.0  glue_1.6.2       
[25] R6_2.5.1          fansi_1.0.4       tzdb_0.3.0        magrittr_2.0.3    scales_1.2.1      ellipsis_0.3.2    colorspace_2.1-0  utf8_1.2.3       
[33] stringi_1.7.12    munsell_0.5.0     R.oo_1.25.0    

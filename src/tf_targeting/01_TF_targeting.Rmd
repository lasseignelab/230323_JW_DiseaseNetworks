---
title: "01_TF_targeting"
output: html_document
date: '2023-02-13'
---

This analysis determines TF targeting scores within tissue types for each tissue-specific PANDA regulatory networks. All networks below were filtered to only include positive weights.

#load in required libraries & functions
```{r loading-libraries-functions, results='hide'}
set.seed(2178)
library(netZooR)
library(data.table)
library(dplyr)
library(patchwork)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(ComplexHeatmap)
library(RColorBrewer)
library(magrittr)
library(circlize)
library(readr)
library(gprofiler2)
library(ggridges)
library(here)
source(here("src/functions.R"))
library(styler)
library(lintr)
ptm <- proc.time()
```

## load gene set 
```{r loading-geneset}
# load in gene set for SETBP1 (converted by LW)
setbp1_genes <- read.csv(here("data/SETBP1_Targets/setbp1_targets_geneconversions.csv"))
setbp1_genes <- setbp1_genes$name %>% as.vector()
```

## affected tissues list
```{r}
affected <- c(
  "BRAIN",
  "HEART",
  "KIDNEY",
  "BLADDER",
  "LUNG",
  "MUSCLE",
  "SMALL_INTESTINE",
  "STOMACH",
  "ESOPHAGUS"
)
```


## setting heatmap data needed for the rest of the script
```{r heatmap-color-annotation}
# setting annotation colors
annotation_colors <- list("tissue" = c(
  "ADIPOSE_TISSUE" = "#000000",
  "ADRENAL_GLAND" = "#FFFFFF",
  "BLADDER" = "#FF0000",
  "BLOOD" = "#00FF00",
  "BLOOD_VESSEL" = "#0000FF",
  "BONE_MARROW" = "#FFFF00",
  "BRAIN" = "#FF00FF",
  "BREAST" = "#00FFFF",
  "CERVIX_UTERI" = "#800000",
  "COLON" = "#008000",
  "ESOPHAGUS" = "#000080",
  "FALLOPIAN_TUBE" = "#808000",
  "HEART" = "#800080",
  "KIDNEY" = "#008080",
  "LIVER" = "#808080",
  "LUNG" = "#C0C0C0",
  "MUSCLE" = "#FFA500",
  "NERVE" = "#A52A2A",
  "OVARY" = "#800080",
  "PANCREAS" = "#FFC0CB",
  "PITUITARY" = "#FFD700",
  "PROSTATE" = "#FF8C00",
  "SALIVARY_GLAND" = "#ADFF2F",
  "SKIN" = "#F0E68C",
  "SMALL_INTESTINE" = "#00FA9A",
  "SPLEEN" = "#F08080",
  "STOMACH" = "#4682B4",
  "TESTIS" = "#B0C4DE",
  "THYROID" = "#00CED1",
  "UTERUS" = "#FF1493",
  "VAGINA" = "#DAA520"
))
```

## load in PANDA object containing list of all cell types from Setbp1 data
Here each item returned by the for loop represents a PANDA object for a given cell type that contains the regNet, coopNet, and coregNet for that cell type.
```{r loading-object, results='hide'}
files <- list.files(here("results/PANDA"),
  full.names = TRUE
) # grabbing file names

files # 31 tissues total

regNet_list <- list()

for (i in files) {
  load(i)
  regNet <- pandaResults
  regNet <- regNet@regNet
  name <- sub(here("results/PANDA/gtex_"), "", i)
  name <- sub("_PANDA.Rdata*", "", name)
  # assign(paste0(name, ".regNet"), regNet)
  regNet_list[[name]] <- regNet
  rm(pandaResults)
  rm(regNet)
}
```

```{r save-object}
# save(regNet_list, file = here("results/tf_targeting/regNet_list.Rdata")) #commented out after first save to avoid overwriting
```

## Visualizing edge weight distributions filtered and unfiltered
```{r visualize-distribution-of-unfiltered-regNet-scores}
# Create an empty list to store the melted data frames
merged_regNet_list <- list()

# Loop through the list and melt the data frames
for (i in seq_along(regNet_list)) {
  melted <- as.data.frame(reshape2::melt(regNet_list[[i]]),
    varnames = c("TF", "gene"),
    value.name = "edge_weight"
  ) # melting dataframe

  melted <- as.data.frame(melted[, 3])
  colnames(melted) <- "edge_weight"

  # Extract the name of the list item and create the 'tissue' column
  melted$tissue <- names(regNet_list)[i]

  # Store the melted data frame in the merged_regNet_list
  merged_regNet_list[[i]] <- melted

  print(paste0(names(regNet_list)[i], " melted and stored"))
}

# naming list  items
names(merged_regNet_list) <- names(regNet_list)

merged <- bind_rows(merged_regNet_list)
```


```{r plotting-edgeweights}
# plotting distribution
png(
  filename = here("results/tf_targeting/regNet_edgeweight_dist.png"),
  width = 1000,
  height = 500
)
ggplot(data = merged, aes(
  x = edge_weight,
  group = tissue, color = tissue
)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Distribution of regNet edge weights in GTEx Data") +
  theme_bw() # +
# scale_color_manual(values = c("#FFBE1D", "#4E3801", "#EEDF37", "#F03F00", "#6D0404", "#AA6320", "#CF9400", "#FFC8C4", "#AA937E", "#C70F0F", "#A85A5A", "#BD085E", "#948802", "#FFE196", "#FF7600", "#F8766D", "#FFE196"))
dev.off()
```

Note: all negative edge weights were changed to 0
```{r visualize-distribution-of-filtered-het-regNet-scores}
# grabbing only positive edge weights
merged_pos <- merged[merged$edge_weight > 0, ]

# plotting only positive het edge weights
png(
  filename = here("results/tf_targeting/regNet_edgeweight_pos_dist.png"),
  width = 1000,
  height = 500
)
ggplot(data = merged_pos, aes(x = edge_weight, group = tissue, color = tissue)) +
  geom_density(adjust = 1.5, alpha = .4) +
  ggtitle("Distribution of regNet edge weights > 0 in GTEx Tissues") +
  theme_bw()
dev.off()
```

## Filtering for only positive edge weights, and calculating targeting scores:
Gene targeting score, a numerical score representing the extent to which a gene is targeted by TFs in a given biological context. The gene targeting score is calculated by summing the weights of all inbound regulatory edges for a gene (https://doi.org/10.3389/fgene.2021.649942). 
* regNetmatrix: The PANDA regNet output matrix of TF and Genes and their edge weights from running pandaR on GTEx expression, TF-Motif, and PPI inputs.


# Investigating TF targeting of Setbp1 in each tissue
```{r calc-targeting}
# filtering for only positive edge weights
gtex_tf_targeting <- tf_targetingCalc_gtex(regNetmatrix_list = regNet_list)
```

```{r constructing-tf-targeting-matrix}
# grabbing targeting scores for genes
tf_targeting <- gtex_tf_targeting %>%
  purrr::reduce(full_join, by = "tf") %>%
  select(., contains(c("tf", "targeting_score"))) # did not grab edge_weight_pos column here

# grabbing colnames and setting for new dataframe generated above
names <- names(gtex_tf_targeting) %>%
  append("tf", .)
colnames(tf_targeting) <- names
```

```{r ridgeline-plot-targeting-scores}
melted <- melt(tf_targeting) # melting data

colnames(melted) <- c("TF", "tissue", "targeting_score")

png(here("results/tf_targeting/TF_targeting_score_ridgeline.png"),
  height = 500, width = 800
)
ggplot(melted) +
  geom_density_ridges(aes(x = targeting_score, y = tissue, fill = tissue),
    alpha = 0.8
  ) +
  theme_bw() +
  ggtitle("TF Targeting Score Distribution in GTEx Tissues")
dev.off()
```

```{r normalize-by-gene-number}
# Create an empty list to store positive edge weight only values from regNet_list
gene_number_list <- list()

for (i in seq_along(regNet_list)) {
  regNetmatrix <- as.data.frame(reshape2::melt(regNet_list[[i]]),
    varnames = c("TF", "gene"),
    value.name = "edge_weight"
  ) # melting dataframe
  colnames(regNetmatrix) <- c("TF", "gene", "edge_weight")
  regNetmatrix <- subset(regNetmatrix, regNetmatrix$edge_weight > 0)
  gene_number_list[[i]] <- regNetmatrix
}

# Create an empty list to store the number of genes corresponding to each TF in each tissue
gene_counts_list <- list()

# loop through
for (i in seq_along(gene_number_list)) {
  regNetmatrix <- gene_number_list[[i]]

  # Calculate the number of unique genes for each TF
  tf_gene_counts <- aggregate(
    gene ~ TF, regNetmatrix,
    function(x) length(unique(x))
  )

  # Store the result in the list
  gene_counts_list[[i]] <- tf_gene_counts
}

names(gene_counts_list) <- names(regNet_list)

# combining intp single dataframe
tf_gene_number <- gene_counts_list %>%
  purrr::reduce(full_join, by = "TF") %>%
  select(., contains(c("TF", "gene"))) # did not grab edge_weight_pos column here

# grabbing colnames and setting for new data frame generated above
names <- names(gene_counts_list) %>%
  append("TF", .)
colnames(tf_gene_number) <- names

# normalizing by number of genes being targeted by each TF in each GTEx tissue
normalized_tf_targeting <- tf_targeting / tf_gene_number
normalized_tf_targeting$TF <- tf_targeting$TF
```

```{r normalized-ridgeline-plot-targeting-scores}
melted <- melt(normalized_tf_targeting) # melting data

colnames(melted) <- c("TF", "tissue", "targeting_score")

png(here("results/tf_targeting/normalizedTF_targeting_score_ridgeline.png"),
  height = 500, width = 800
)
ggplot(melted) +
  geom_density_ridges(aes(x = targeting_score, y = tissue, fill = tissue),
    alpha = 0.8
  ) +
  theme_bw() +
  ggtitle("Normalized TF Targeting Score Distribution in GTEx Tissues")
dev.off()
```


```{r find-top-targeted-genes-within-tissue}
tissues <- colnames(tf_targeting) %>% .[which(. != "TF")]
tissues
```

```{r}
tf_rank <- list() # creating empty list to store within

for (i in tissues) {
  rank <- normalized_tf_targeting[, names(normalized_tf_targeting) %in% c("TF", i)] %>%
    .[order(.[i], decreasing = TRUE), ] %>%
    mutate(rank = seq_len(nrow(.))) %>%
    mutate(tissue = i) %>%
    rename(targeting_score = i)
  tf_rank[[i]] <- rank
}

tf_rank_all <- do.call(bind_rows, tf_rank)
```

```{r het-setbp1-tf-targets-within}
data <- tf_rank_all[tf_rank_all$TF %in% setbp1_genes, ]

## formatting input data
data <- data[, c("TF", "targeting_score", "tissue"), drop = FALSE]
data <- pivot_wider(data,
  names_from = c("tissue"),
  values_from = "targeting_score",
  names_repair = "minimal"
)
data[is.na(data)] <- 0
names <- data$tf # add tf names as rownames
data <- data[, -1, drop = FALSE] # drop tf column
rownames(data) <- names

# setting meta colname
meta_colname <- "tissue"
# setting plot path
plot_path <- here("results/tf_targeting/normalized_tf_targeting_geneset_within_tissue.png")
# setting rowtitle
rowtitle <- "TFs"
# setting columntitle
plot_title <- "Targeting of Setbp1 and known target TFs within GTEx tissues"

targeting_heatmap(annotation_colors, data, meta_colname, plot_path, rowtitle, plot_title, show_names = TRUE, width = 3000, height = 5000)
```

```{r visualizing-affected-tissues}
data <- tf_rank_all[tf_rank_all$TF == "SETBP1", ]

data$tissue_status <- ifelse(data$tissue %in% affected, "affected", "not_affected")

# Plot the lollipop plot with the color condition
png(
  filename = here("results/tf_targeting/SETBP1_normalized_tf_targeting_lolli.png"),
  width = 2000,
  height = 1500,
  res = 300
)
tf_lolli <- ggplot(data, aes(x = tissue, y = targeting_score)) +
  geom_segment(aes(x = tissue, xend = tissue, y = 0, yend = targeting_score)) +
  geom_point(size = 5, aes(fill = tissue_status), color = "black", alpha = 1, shape = 21) +
  scale_fill_manual(values = c("affected" = "#2C1D6C", "not_affected" = alpha("#D3B1C5", 0.3))) +
  theme_bw() +
  coord_flip() +
  ggtitle("TF Targeting Scores of SETBP1 in GTEx Tissues") +
  labs(x = "GTEx Tissue", y = "Normalized Targeting Score", fill = "Tissue Status") +
  theme(text = element_text(family = "Helvetica")) +
  theme(axis.text.x = element_text(color = "black")) +
  theme(axis.text.y = element_text(color = "black")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.title.y = element_text(face = "bold")) +
  theme(axis.title.x = element_text(face = "bold")) +
  theme(title = element_text(face = "bold")) +
  theme(plot.title = element_text(hjust = 0))
tf_lolli
dev.off()
```

```{r}
fptm <- proc.time() - ptm
fptm[3] / 60
```


```{r}
# run style
style_file(here("src/tf_targeting/01_TF_targeting.Rmd"))
# lintr was run as well
```


```{r}
sessionInfo()
```
